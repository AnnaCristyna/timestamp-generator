<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Gerador de Timestamp para YouTube</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 50px auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-top: 5px;
    }

    .output {
      height: 200px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
    }

    .file-list {
      margin-top: 10px;
      font-size: 0.9em;
    }

    label {
      display: block;
      margin-top: 15px;
    }

    input[type="number"] {
      width: 80px;
    }

    #downloadLink {
      display: none;
      margin-top: 10px;
      text-decoration: none;
      color: white;
      background-color: green;
      padding: 8px 16px;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <h1>Gerador de Timestamp para YouTube</h1>

  <label>
    Escolher pasta:
    <input type="file" id="fileInput" webkitdirectory multiple>
  </label>

  <div class="file-list" id="fileList"></div>

  <label>
    Segundos antes de começar:
    <input type="number" id="offsetInput" min="0" value="0"> segundos
  </label>

  <label>
    Nomes dos capítulos (um por linha):
    <textarea id="chapterNames" placeholder="Exemplo:
Introdução
Tema Principal
Entrevista
Encerramento"></textarea>
  </label>

  <button onclick="gerar()">Gerar Timestamp</button>

  <a id="downloadLink" download="timestamps.txt">Baixar arquivo .txt</a>

  <textarea id="output" class="output" placeholder="O resultado aparecerá aqui..."></textarea>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileListDiv = document.getElementById('fileList');
    const offsetInput = document.getElementById('offsetInput');
    const output = document.getElementById('output');
    const chapterNamesInput = document.getElementById('chapterNames');
    const downloadLink = document.getElementById('downloadLink');

    let arquivosSelecionados = [];

    const extensoesValidas = ['.wav', '.mp3', '.m4a', '.flac', '.ogg', '.aac'];

    fileInput.addEventListener('change', (event) => {
      arquivosSelecionados = Array.from(event.target.files)
        .filter(file => {
          const nome = file.name.toLowerCase();
          return extensoesValidas.some(ext => nome.endsWith(ext));
        })
        .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

      if (arquivosSelecionados.length === 0) {
        fileListDiv.innerHTML = 'Nenhum arquivo de áudio encontrado na pasta.';
      } else {
        fileListDiv.innerHTML = `<strong>${arquivosSelecionados.length}</strong> arquivos de áudio encontrados:<br>` +
          arquivosSelecionados.map(f => f.name).join('<br>');
      }
    });

    async function gerar() {
      if (arquivosSelecionados.length === 0) {
        alert('Selecione uma pasta que contenha arquivos de áudio.');
        return;
      }

      const offset = parseFloat(offsetInput.value) || 0;
      const nomesCapitulos = chapterNamesInput.value.trim().split('\n').map(n => n.trim()).filter(n => n);

      if (nomesCapitulos.length !== arquivosSelecionados.length) {
        alert(`O número de nomes dos capítulos (${nomesCapitulos.length}) não corresponde ao número de arquivos de áudio (${arquivosSelecionados.length}).`);
        return;
      }

      let timestamps = [];
      let acumulado = offset;

      for (let i = 0; i < arquivosSelecionados.length; i++) {
        const file = arquivosSelecionados[i];
        const duracao = await obterDuracao(file);
        const timestamp = formatarTempo(acumulado);

        timestamps.push(`${timestamp} ${nomesCapitulos[i]}`);

        acumulado += duracao;
      }

      const resultado = timestamps.join('\n');
      output.value = resultado;

      gerarArquivoTxt(resultado);
    }

    function gerarArquivoTxt(conteudo) {
      const blob = new Blob([conteudo], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.style.display = 'inline-block';
    }

    function formatarTempo(segundos) {
      const h = Math.floor(segundos / 3600);
      const m = Math.floor((segundos % 3600) / 60);
      const s = Math.floor(segundos % 60);
      return `${h > 0 ? String(h).padStart(2, '0') + ':' : ''}${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function obterDuracao(file) {
      return new Promise((resolve, reject) => {
        const elemento = document.createElement('audio');
        elemento.preload = 'metadata';

        elemento.onloadedmetadata = function () {
          URL.revokeObjectURL(elemento.src);
          resolve(elemento.duration);
        };

        elemento.onerror = function () {
          reject("Erro ao carregar " + file.name);
        };

        elemento.src = URL.createObjectURL(file);
      });
    }
  </script>
</body>

</html>